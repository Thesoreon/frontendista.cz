name: "CI"

on: [pull_request]

env:
  NEXT_PUBLIC_DOMAIN: http://localhost:3000
  SANITY_CLIENT_TOKEN: ${{ secrets.SANITY_CLIENT_TOKEN }}
  SANITY_PROJECT_ID: ${{ secrets.SANITY_PROJECT_ID }}
  SANITY_DATASET_ID: ${{ secrets.SANITY_DATASET_ID }}

jobs:
  codeclimate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: "14.x"

      - name: Get yarn cache
        id: yarn-cache
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - name: Cache
        uses: actions/cache@v2
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-

      - name: install dependencies
        run: yarn install

      - name: lint:code
        run: yarn lint:code

      - name: lint:style
        run: yarn lint:style

      - name: build
        run: yarn build

  bundlediff:
    runs-on: ubuntu-latest
    needs: [codeclimate]

    steps:
      - uses: actions/checkout@v2

      - name: compressed-size-action
        uses: preactjs/compressed-size-action@v2
        with:
          pattern: "./.next/static/{chunks,css}/**/*.{js,css}"
          strip-hash: "\\b-[a-z0-9]{1,}\\b"
